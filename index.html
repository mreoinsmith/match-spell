<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mega Match & Spell</title>
    <style>
        /* --- UNIVERSAL CSS RESET & VARIABLES --- */
        :root {
            --primary: #4fc3f7;
            --primary-dark: #0288d1;
            --accent: #ff7043;
            --bg-gradient: linear-gradient(135deg, #e0f7fa 0%, #fff9c4 100%);
            --shadow-soft: 0 10px 25px rgba(0,0,0,0.15);
            --font-main: 'Comic Sans MS', 'Chalkboard SE', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Vertical centering */
            min-height: 100dvh;
            padding: 20px;
            color: #333;
            -webkit-font-smoothing: antialiased;
        }

        /* --- CONTAINER / SCREEN STYLES --- */
        .game-wrapper {
            width: 100%;
            max-width: 650px;
            margin: auto;
            position: relative;
        }

        .screen {
            background-color: #ffffff;
            width: 100%;
            padding: 25px;
            border-radius: 25px;
            box-shadow: var(--shadow-soft);
            text-align: center;
            border: 6px solid var(--primary);
            display: none;
            animation: slideIn 0.3s ease-out;
            margin-bottom: 20px;
        }

        .screen.active {
            display: block;
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            color: var(--accent);
            font-size: 2rem;
            margin: 0 0 10px 0;
            line-height: 1.2;
        }
        
        p.subtitle {
            margin-top: 0;
            color: #78909c;
            font-size: 0.9rem;
        }

        h3 {
            color: #546e7a;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- MENU: DIFFICULTY BUTTONS (MULTI-SELECT) --- */
        .difficulty-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .diff-btn {
            flex: 1 1 45%;
            padding: 12px 10px;
            background: #f1f8e9;
            border: 2px solid #c5e1a5;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #558b2f;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: inherit;
            position: relative;
        }

        /* Selected State */
        .diff-btn.selected {
            background: #4fc3f7;
            color: white;
            border-color: #039be5;
            box-shadow: 0 4px 0 #0277bd;
            transform: translateY(-2px);
        }
        
        /* Checkmark indicator for selected items */
        .diff-btn.selected::after {
            content: "‚úì";
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 1rem;
            color: #fff;
        }

        /* --- MENU: CATEGORY GRID --- */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .cat-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            color: white;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15);
        }

        .cat-btn:active { transform: scale(0.96); box-shadow: none; }
        .cat-btn span { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* Category Colors */
        .c-animals { background: #ffca28; }
        .c-food { background: #ef5350; }
        .c-vehicles { background: #5c6bc0; }
        .c-space { background: #37474f; }
        .c-weather { background: #42a5f5; }
        .c-emotions { background: #66bb6a; }

        /* --- GAMEPLAY UI --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #555;
        }

        .back-btn {
            background: #eceff1;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #455a64;
            font-family: inherit;
        }

        .score-box {
            background: #fff9c4;
            padding: 6px 14px;
            border-radius: 12px;
            box-shadow: 0 2px 0 #fbc02d;
        }

        .emoji-display {
            font-size: 90px;
            margin: 10px 0 25px 0;
            line-height: 1;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
            user-select: none;
        }

        /* --- SAFARI FIX: FLEX CENTERING --- */
        /* Answer Slots */
        .slots-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin: 0 auto 30px auto; /* Auto margin fixes some centering issues */
            min-height: 60px;
            max-width: 100%; /* Prevent overflow */
        }

        .slot {
            width: 48px;
            height: 58px;
            background-color: #eeeeee;
            border-bottom: 4px solid #bdbdbd;
            border-radius: 10px;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent squishing */
        }

        .slot.filled {
            background-color: #ffffff;
            border-bottom: 4px solid var(--primary-dark);
            color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .slot.active {
            background-color: #fffde7;
            border: 2px solid #ffca28;
            box-shadow: 0 0 8px #ffca28;
        }

        /* Draggable/Clickable Tiles - Safari Fix */
        .tiles-container {
            display: flex;
            justify-content: center; /* Main centering logic */
            flex-wrap: wrap;
            gap: 10px;
            margin: 0 auto 25px auto; /* Auto margins */
            min-height: 60px;
            width: 100%; /* Ensure full width available */
        }

        .tile {
            width: 48px;
            height: 58px;
            background-color: #ffca28;
            color: #3e2723;
            border: none;
            border-bottom: 4px solid #ff8f00;
            border-radius: 10px;
            font-size: 26px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            touch-action: manipulation;
            flex-shrink: 0; /* Prevent shrinking */
            
            /* Explicit Flex alignment for Safari internals */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .tile:active { transform: translateY(4px); border-bottom: 0; }
        .tile.used { opacity: 0; pointer-events: none; }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-family: inherit;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-reset { background-color: #ffb74d; }
        .btn-skip { background-color: #90a4ae; }

        .message {
            margin-top: 15px;
            min-height: 25px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .correct-text { color: #2e7d32; }
        .error-msg { color: #d32f2f; display: none; margin-top: 10px; font-weight: bold; }

        /* --- ANIMATIONS --- */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop-anim { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- MEDIA QUERIES --- */
        @media (max-width: 480px) {
            .screen { padding: 15px; }
            h1 { font-size: 1.6rem; }
            
            .emoji-display { font-size: 70px; margin-bottom: 15px; }
            
            .slot, .tile {
                width: 40px;
                height: 50px;
                font-size: 22px;
                border-bottom-width: 3px;
            }
            
            .cat-btn span { font-size: 1.5rem; }
            .cat-btn { font-size: 0.9rem; }
            
            .diff-btn { font-size: 0.85rem; padding: 10px 5px; }
        }

    </style>
</head>
<body>

<div class="game-wrapper">

    <div id="menuScreen" class="screen active">
        <h1>‚ú® Match & Spell ‚ú®</h1>
        <p class="subtitle">Select one or more levels to play!</p>
        
        <h3>1. Pick Levels (Multi-Select)</h3>
        <div class="difficulty-row">
            <button class="diff-btn selected" data-min="0" data-max="3" onclick="toggleDifficulty(this)">
                Tiny<br>(2-3)
            </button>
            <button class="diff-btn" data-min="3" data-max="5" onclick="toggleDifficulty(this)">
                Little<br>(3-5)
            </button>
            <button class="diff-btn" data-min="5" data-max="7" onclick="toggleDifficulty(this)">
                Big<br>(5-7)
            </button>
            <button class="diff-btn" data-min="7" data-max="20" onclick="toggleDifficulty(this)">
                Super<br>(7+)
            </button>
        </div>

        <h3>2. Pick Topic</h3>
        <div class="menu-grid">
            <button class="cat-btn c-animals" onclick="startGame('animals')"><span>ü¶Å</span>Animals</button>
            <button class="cat-btn c-food" onclick="startGame('food')"><span>üçï</span>Food</button>
            <button class="cat-btn c-vehicles" onclick="startGame('vehicles')"><span>üöÄ</span>Go!</button>
            <button class="cat-btn c-space" onclick="startGame('space')"><span>ü™ê</span>Space</button>
            <button class="cat-btn c-weather" onclick="startGame('weather')"><span>üåßÔ∏è</span>Sky</button>
            <button class="cat-btn c-emotions" onclick="startGame('emotions')"><span>üòä</span>Feelings</button>
        </div>

        <div id="menuError" class="error-msg">Please select at least one level and try again!</div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="header">
            <button class="back-btn" onclick="goToMenu()">¬´ Back</button>
            <span id="gameTitle" style="text-transform: uppercase;">TOPIC</span>
            <div class="score-box">‚≠ê <span id="scoreVal">0</span></div>
        </div>

        <div id="emoji" class="emoji-display">ü¶Å</div>

        <div class="slots-container" id="slotsArea"></div>
        <div class="tiles-container" id="tilesArea"></div>

        <div class="controls">
            <button class="btn btn-reset" onclick="resetRound()">Reset ‚Ü∫</button>
            <button class="btn btn-skip" onclick="skipItem()">Skip ‚è©</button>
        </div>

        <div id="message" class="message"></div>
    </div>

</div>

<script>
    // --- DATA LIBRARY ---
    const data = {
        animals: [
            {n:"CAT",e:"üê±"}, {n:"DOG",e:"üê∂"}, {n:"PIG",e:"üê∑"}, {n:"COW",e:"üêÆ"}, 
            {n:"BAT",e:"ü¶á"}, {n:"FOX",e:"ü¶ä"}, {n:"BEE",e:"üêù"}, {n:"ANT",e:"üêú"},
            {n:"YAK",e:"üêÇ"}, {n:"OWL",e:"ü¶â"}, {n:"BUG",e:"üêõ"},
            {n:"LION",e:"ü¶Å"}, {n:"BEAR",e:"üêª"}, {n:"DUCK",e:"ü¶Ü"}, {n:"FROG",e:"üê∏"},
            {n:"FISH",e:"üê†"}, {n:"WOLF",e:"üê∫"}, {n:"DEER",e:"ü¶å"}, {n:"CRAB",e:"ü¶Ä"},
            {n:"BIRD",e:"üê¶"}, {n:"WORM",e:"ü™±"}, {n:"TIGER",e:"üêØ"}, {n:"HORSE",e:"üê¥"},
            {n:"ZEBRA",e:"ü¶ì"}, {n:"SHEEP",e:"üêë"}, {n:"GOAT",e:"üêê"}, {n:"MOUSE",e:"üê≠"},
            {n:"SNAKE",e:"üêç"}, {n:"WHALE",e:"üê≥"}, {n:"SHARK",e:"ü¶à"}, {n:"EAGLE",e:"ü¶Ö"},
            {n:"PANDA",e:"üêº"}, {n:"KOALA",e:"üê®"}, {n:"CAMEL",e:"üê´"},
            {n:"MONKEY",e:"üêµ"}, {n:"RABBIT",e:"üê∞"}, {n:"TURTLE",e:"üê¢"}, {n:"SPIDER",e:"üï∑Ô∏è"},
            {n:"DONKEY",e:"ü´è"}, {n:"TURKEY",e:"ü¶É"}, {n:"LIZARD",e:"ü¶é"}, {n:"PARROT",e:"ü¶ú"},
            {n:"DOLPHIN",e:"üê¨"}, {n:"PENGUIN",e:"üêß"}, {n:"GIRAFFE",e:"ü¶í"}, {n:"ELEPHANT",e:"üêò"},
            {n:"KANGAROO",e:"ü¶ò"}, {n:"SQUIRREL",e:"üêøÔ∏è"}, {n:"GORILLA",e:"ü¶ç"}, {n:"BUTTERFLY",e:"ü¶ã"},
            {n:"OCTOPUS",e:"üêô"}, {n:"CROCODILE",e:"üêä"}, {n:"FLAMINGO",e:"ü¶©"}, {n:"DINOSAUR",e:"ü¶ñ"}
        ],
        food: [
            {n:"EGG",e:"ü•ö"}, {n:"PIE",e:"ü•ß"}, {n:"TEA",e:"üçµ"}, {n:"NUT",e:"ü•ú"}, {n:"JAM",e:"üçØ"},
            {n:"CAKE",e:"üéÇ"}, {n:"KIWI",e:"ü•ù"}, {n:"CORN",e:"üåΩ"}, {n:"PEAR",e:"üçê"},
            {n:"MILK",e:"ü•õ"}, {n:"MEAT",e:"ü•©"}, {n:"RICE",e:"üçö"}, {n:"SOUP",e:"üç≤"},
            {n:"TACO",e:"üåÆ"}, {n:"BREAD",e:"üçû"}, {n:"APPLE",e:"üçé"}, {n:"LEMON",e:"üçã"},
            {n:"SUSHI",e:"üç£"}, {n:"PIZZA",e:"üçï"}, {n:"DONUT",e:"üç©"}, {n:"CANDY",e:"üç¨"},
            {n:"FRUIT",e:"üçá"}, {n:"HONEY",e:"üçØ"}, {n:"FRIES",e:"üçü"},
            {n:"BANANA",e:"üçå"}, {n:"BURGER",e:"üçî"}, {n:"ORANGE",e:"üçä"}, {n:"TOMATO",e:"üçÖ"},
            {n:"POTATO",e:"ü•î"}, {n:"CARROT",e:"ü•ï"}, {n:"COOKIE",e:"üç™"}, {n:"CHEESE",e:"üßÄ"},
            {n:"HOTDOG",e:"üå≠"}, {n:"POPCORN",e:"üçø"}, {n:"CHICKEN",e:"üçó"}, {n:"AVOCADO",e:"ü•ë"},
            {n:"NOODLES",e:"üçú"}, {n:"CUPCAKE",e:"üßÅ"}, {n:"SANDWICH",e:"ü•™"}, {n:"CHOCOLATE",e:"üç´"},
            {n:"STRAWBERRY",e:"üçì"}, {n:"WATERMELON",e:"üçâ"}, {n:"SPAGHETTI",e:"üçù"}, {n:"PINEAPPLE",e:"üçç"}
        ],
        vehicles: [
            {n:"BUS",e:"üöå"}, {n:"CAR",e:"üöó"}, {n:"JET",e:"‚úàÔ∏è"}, {n:"VAN",e:"üöê"},
            {n:"TAXI",e:"üöï"}, {n:"BIKE",e:"üö≤"}, {n:"BOAT",e:"‚õµ"}, {n:"SHIP",e:"üö¢"},
            {n:"TRUCK",e:"üöö"}, {n:"TRAIN",e:"üöÇ"}, {n:"CANOE",e:"üõ∂"}, {n:"PLANE",e:"‚úàÔ∏è"},
            {n:"METRO",e:"üöá"}, 
            {n:"ROCKET",e:"üöÄ"}, {n:"SCOOTER",e:"üõ¥"}, {n:"TRACTOR",e:"üöú"}, {n:"SAILBOAT",e:"‚õµ"},
            {n:"MINIVAN",e:"üöê"}, {n:"AIRPLANE",e:"‚úàÔ∏è"}, {n:"AMBULANCE",e:"üöë"}, {n:"FIRETRUCK",e:"üöí"},
            {n:"POLICECAR",e:"üöì"}, {n:"HELICOPTER",e:"üöÅ"}, {n:"MOTORCYCLE",e:"üèçÔ∏è"}, {n:"SUBMARINE",e:"üö¢"}
        ],
        space: [
            {n:"SUN",e:"‚òÄÔ∏è"}, 
            {n:"MOON",e:"üåô"}, {n:"STAR",e:"‚≠ê"}, {n:"MARS",e:"üü†"}, {n:"UFO",e:"üõ∏"}, 
            {n:"EARTH",e:"üåç"}, {n:"ALIEN",e:"üëΩ"}, {n:"COMET",e:"‚òÑÔ∏è"}, {n:"VENUS",e:"üü°"},
            {n:"SATURN",e:"ü™ê"}, {n:"URANUS",e:"üîµ"}, {n:"PLANET",e:"ü™ê"}, {n:"GALAXY",e:"üåå"},
            {n:"NEBULA",e:"üå´Ô∏è"}, {n:"ROCKET",e:"üöÄ"}, {n:"METEOR",e:"üå†"}, {n:"JUPITER",e:"üü§"},
            {n:"TELESCOPE",e:"üî≠"}, {n:"SATELLITE",e:"üõ∞Ô∏è"}, {n:"ASTRONAUT",e:"üßë‚ÄçüöÄ"}
        ],
        weather: [
            {n:"SUN",e:"‚òÄÔ∏è"}, {n:"HOT",e:"ü•µ"}, {n:"FOG",e:"üå´Ô∏è"}, {n:"ICE",e:"üßä"},
            {n:"RAIN",e:"üåßÔ∏è"}, {n:"SNOW",e:"‚ùÑÔ∏è"}, {n:"WIND",e:"üí®"}, {n:"COLD",e:"ü•∂"},
            {n:"FIRE",e:"üî•"}, {n:"STORM",e:"‚õàÔ∏è"}, {n:"CLOUD",e:"‚òÅÔ∏è"}, 
            {n:"THUNDER",e:"‚ö°"}, {n:"TORNADO",e:"üå™Ô∏è"}, {n:"RAINBOW",e:"üåà"}, {n:"UMBRELLA",e:"‚òÇÔ∏è"},
            {n:"LIGHTNING",e:"‚ö°"}, {n:"SNOWFLAKE",e:"‚ùÑÔ∏è"}, {n:"SUNGLASSES",e:"üï∂Ô∏è"}
        ],
        emotions: [
            {n:"SAD",e:"üò¢"}, {n:"MAD",e:"üò°"}, {n:"JOY",e:"üòÅ"}, {n:"ILL",e:"ü§¢"},
            {n:"LOVE",e:"üòç"}, {n:"COOL",e:"üòé"}, {n:"SICK",e:"ü§¢"}, {n:"CALM",e:"üòå"},
            {n:"HAPPY",e:"üòä"}, {n:"ANGRY",e:"üò°"}, {n:"TIRED",e:"üò¥"}, {n:"SILLY",e:"ü§™"},
            {n:"BORED",e:"üòê"}, {n:"QUIET",e:"ü§´"}, 
            {n:"SCARED",e:"üò±"}, {n:"SHOCKED",e:"üò≤"}, {n:"SLEEPY",e:"üò™"}, {n:"NERVOUS",e:"üò¨"},
            {n:"EXCITED",e:"ü§©"}, {n:"CONFUSED",e:"üòï"}, {n:"SURPRISED",e:"üòÆ"}, {n:"LAUGHING",e:"üòÇ"}
        ]
    };

    // --- GAME STATE ---
    let selectedLevels = []; // Array of objects {min: x, max: y}
    let currentList = [];
    let currentItem = {};
    let filledSlots = []; 
    let score = 0;

    // --- DOM REFERENCES ---
    const menuScreen = document.getElementById('menuScreen');
    const gameScreen = document.getElementById('gameScreen');
    const gameTitle = document.getElementById('gameTitle');
    const menuError = document.getElementById('menuError');
    const emojiDiv = document.getElementById("emoji");
    const slotsArea = document.getElementById("slotsArea");
    const tilesArea = document.getElementById("tilesArea");
    const msgDiv = document.getElementById("message");
    const scoreSpan = document.getElementById("scoreVal");

    // --- INIT ---
    // Select first level by default on load
    document.addEventListener('DOMContentLoaded', () => {
        const firstBtn = document.querySelector('.diff-btn');
        updateSelectedLevels();
    });

    // --- SETTINGS: Multi-Select Logic ---
    function toggleDifficulty(btn) {
        btn.classList.toggle('selected');
        menuError.style.display = 'none';
        updateSelectedLevels();
    }

    function updateSelectedLevels() {
        selectedLevels = [];
        const btns = document.querySelectorAll('.diff-btn.selected');
        btns.forEach(btn => {
            selectedLevels.push({
                min: parseInt(btn.dataset.min),
                max: parseInt(btn.dataset.max)
            });
        });
    }

    // --- GAME LOGIC ---
    function startGame(category) {
        if (selectedLevels.length === 0) {
            menuError.innerText = "Please select at least one level!";
            menuError.style.display = 'block';
            return;
        }

        const rawList = data[category];
        
        // Filter list: Check if word matches ANY of the selected ranges
        currentList = rawList.filter(item => {
            const len = item.n.length;
            // Returns true if length fits in ANY selected range
            return selectedLevels.some(range => len >= range.min && len <= range.max);
        });

        if (currentList.length === 0) {
            menuError.innerText = "No words found for these levels! Try selecting others.";
            menuError.style.display = 'block';
            return;
        }

        // Setup UI
        gameTitle.innerText = category;
        score = 0;
        scoreSpan.innerText = score;

        // Swap Screens
        menuScreen.classList.remove('active');
        gameScreen.classList.add('active');
        menuError.style.display = 'none';

        loadNewItem();
    }

    function goToMenu() {
        gameScreen.classList.remove('active');
        menuScreen.classList.add('active');
    }

    // --- ROUND LOGIC ---
    function loadNewItem() {
        const randomIndex = Math.floor(Math.random() * currentList.length);
        currentItem = currentList[randomIndex];
        filledSlots = new Array(currentItem.n.length).fill(null);
        
        emojiDiv.innerText = currentItem.e;
        emojiDiv.classList.remove("pop-anim");
        void emojiDiv.offsetWidth; 
        msgDiv.innerText = "";
        
        createLayout();
    }

    function createLayout() {
        slotsArea.innerHTML = "";
        tilesArea.innerHTML = "";

        // Create Slots
        for (let i = 0; i < currentItem.n.length; i++) {
            let slot = document.createElement("div");
            slot.className = "slot";
            if (i === 0) slot.classList.add("active");
            slot.onclick = () => undoSlot(i);
            slotsArea.appendChild(slot);
        }

        // Create Tiles (Shuffled)
        let lettersObj = currentItem.n.split("").map((char, index) => {
            return { char: char, id: `tile-${index}` };
        });
        
        // Fisher-Yates Shuffle
        for (let i = lettersObj.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [lettersObj[i], lettersObj[j]] = [lettersObj[j], lettersObj[i]];
        }

        lettersObj.forEach(obj => {
            let btn = document.createElement("button");
            btn.className = "tile";
            btn.innerText = obj.char;
            btn.id = obj.id;
            btn.onclick = () => useLetter(obj.id, obj.char);
            tilesArea.appendChild(btn);
        });
    }

    function useLetter(tileId, char) {
        const emptyIndex = filledSlots.findIndex(item => item === null);
        if (emptyIndex !== -1) {
            filledSlots[emptyIndex] = tileId;
            
            // Visual Update Slot
            const slot = slotsArea.children[emptyIndex];
            slot.innerText = char;
            slot.classList.add("filled");
            slot.classList.remove("active");

            // Visual Update Tile
            document.getElementById(tileId).classList.add("used");

            // Move Highlight
            if (emptyIndex + 1 < filledSlots.length) {
                slotsArea.children[emptyIndex + 1].classList.add("active");
            }
            checkWin();
        }
    }

    function undoSlot(index) {
        if (filledSlots[index] !== null) {
            const tileId = filledSlots[index];
            filledSlots[index] = null;

            const slot = slotsArea.children[index];
            slot.innerText = "";
            slot.classList.remove("filled");

            document.getElementById(tileId).classList.remove("used");
            updateHighlights();
        }
    }

    function updateHighlights() {
        Array.from(slotsArea.children).forEach(s => s.classList.remove("active"));
        const firstEmpty = filledSlots.findIndex(item => item === null);
        if (firstEmpty !== -1) slotsArea.children[firstEmpty].classList.add("active");
    }

    function checkWin() {
        if (!filledSlots.includes(null)) {
            let formedWord = "";
            filledSlots.forEach(id => formedWord += document.getElementById(id).innerText);

            if (formedWord === currentItem.n) {
                // Correct
                score++;
                scoreSpan.innerText = score;
                msgDiv.className = "message correct-text";
                msgDiv.innerText = "üåü Correct! üåü";
                emojiDiv.classList.add("pop-anim");
                
                // Lock tiles
                Array.from(document.querySelectorAll(".tile")).forEach(b => b.disabled = true);
                
                setTimeout(loadNewItem, 1500);
            }
        }
    }

    function resetRound() {
        filledSlots.fill(null);
        Array.from(slotsArea.children).forEach(s => { s.innerText = ""; s.className = "slot"; });
        Array.from(tilesArea.children).forEach(t => t.classList.remove("used"));
        updateHighlights();
    }

    function skipItem() {
        msgDiv.className = "message";
        msgDiv.style.color = "#ef6c00";
        msgDiv.innerText = `It was ${currentItem.n}!`;
        setTimeout(loadNewItem, 1500);
    }

    // Keyboard Support
    document.addEventListener("keydown", (e) => {
        if (!gameScreen.classList.contains('active')) return;
        
        const key = e.key.toUpperCase();
        if (key === "BACKSPACE") {
            for (let i = filledSlots.length - 1; i >= 0; i--) {
                if (filledSlots[i] !== null) { undoSlot(i); break; }
            }
        } else if (key.match(/^[A-Z]$/)) {
            const tiles = Array.from(tilesArea.children);
            const available = tiles.find(t => t.innerText === key && !t.classList.contains("used"));
            if (available) useLetter(available.id, key);
        }
    });

</script>
</body>
</html>
